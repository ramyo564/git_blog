---
layout: single
title: "[Todo] 트러블 슈팅 & TIL (2)"
categories: Spring_Project_AI_Todo
toc: true
toc_sticky: true
author_profile: false
sidebar: 
tags:
---
# Auth & OAuth2

## UseCase

### 1. UC-AUTH-001: 일반 사용자 로그인 (General User Login)

```mermaid
sequenceDiagram
    title UC-AUTH-001: General User Login
    actor User
    participant Client as Client (Web/Mobile)
    participant AuthController as AuthController (Presentation Layer)
    participant AuthService as AuthService (Application Layer)
    participant PasswordEncoder
    participant AuthenticationManager as AuthManager
    participant UserDetailsService
    participant RefreshTokenService as RefreshTokenService (Infrastructure Layer)
    participant JwtProvider as JwtProvider (Infrastructure Layer)
    participant Redis
    participant AuditLogger

    User->>Client: 1. Username/Password Login Request
    Client->>AuthController: 2. POST /api/auth/login (Username, Password)
    activate AuthController
    AuthController->>AuthService: 3. login(Username, Password)
    activate AuthService
    AuthService->>AuthManager: 3.1. authenticate(UsernamePasswordAuthenticationToken)
    activate AuthManager
    AuthManager->>UserDetailsService: 3.1.1. loadUserByUsername(Username)
    activate UserDetailsService
    UserDetailsService-->>AuthManager: 3.1.2. UserDetails
    deactivate UserDetailsService
    AuthManager->>PasswordEncoder: 3.1.3. matches(Raw, Encoded)
    activate PasswordEncoder
    PasswordEncoder-->>AuthManager: 3.1.4. true/false
    deactivate PasswordEncoder
    AuthManager-->>AuthService: 3.2. Authentication (Success/Failure)
    deactivate AuthManager

    alt Authentication Success
        AuthService->>JwtProvider: 3.3. generateAccessToken(Username)
        activate JwtProvider
        AuthService->>JwtProvider: 3.4. generateRefreshToken(Username)
        JwtProvider-->>AuthService: 3.5. AccessToken, RefreshToken
        deactivate JwtProvider
        AuthService->>RefreshTokenService: 3.6. saveRefreshToken(Username, RefreshToken)
        activate RefreshTokenService
        RefreshTokenService->>Redis: 3.6.1. SET [Username]:RefreshToken
        activate Redis
        Redis-->>RefreshTokenService: 3.6.2. OK
        deactivate Redis
        RefreshTokenService-->>AuthService: 3.7. OK
    else Authentication Failure
        AuthService->>AuditLogger: 3.8'. Log: User Login Failed
        AuthService-->>AuthController: 4'. AuthenticationException
    end
    deactivate RefreshTokenService
    deactivate AuthService
    AuthService->>AuditLogger: 3.8. Log: User Login Success
    AuthController-->>Client: 5. HTTP 200 OK (AccessToken in Body, RefreshToken in HttpOnly Cookie)
    deactivate AuthController

    Client-->>User: 6. Login Result
```


### 2. UC-AUTH-002: OAuth2 (Google) 로그인 (OAuth2 (Google) Login)

```mermaid
sequenceDiagram
    title UC-AUTH-002: OAuth2 (Google) Login
    actor User
    participant Client as Client (Web/Mobile)
    participant OAuth2 Provider as OAuth2 Provider (e.g., Google)
    participant AuthController as AuthController (Presentation Layer)
    participant SecurityFilter as Spring Security Filter Chain
    participant CookieAuthReqRepo as CookieOAuth2AuthorizationRequestRepository
    participant OAuth2UserService as CustomOAuth2UserService
    participant UserService as UserService (Application Layer)
    participant UserRepo as UserRepository (Infrastructure Layer)
    participant OAuth2AuthSuccessHandler as OAuth2AuthenticationSuccessHandler
    participant JwtProvider as JwtProvider (Infrastructure Layer)
    participant RefreshTokenService as RefreshTokenService (Infrastructure Layer)
    participant Redis
    participant AuditLogger

    User->>Client: 1. Click "Login with Google"
    Client->>SecurityFilter: 2. Redirect to /oauth2/authorization/google
    activate SecurityFilter
    SecurityFilter->>CookieAuthReqRepo: 2.1. saveAuthorizationRequest()
    activate CookieAuthReqRepo
    CookieAuthReqRepo-->>SecurityFilter: 2.2. OAuth2AuthRequest (in HttpOnly cookie)
    deactivate CookieAuthReqRepo
    SecurityFilter->>OAuth2 Provider: 2.3. Redirect for Authorization
    deactivate SecurityFilter

    OAuth2 Provider->>User: 3. Google Login/Consent Page
    User->>OAuth2 Provider: 4. Authorize Application
    OAuth2 Provider->>Client: 5. Redirect back with Authorization Code to /login/oauth2/code/google

    Client->>SecurityFilter: 6. Callback with Authorization Code
    activate SecurityFilter
    SecurityFilter->>CookieAuthReqRepo: 6.1. removeAuthorizationRequest()
    activate CookieAuthReqRepo
    CookieAuthReqRepo-->>SecurityFilter: 6.2. OAuth2AuthRequest (from cookie)
    deactivate CookieAuthReqRepo
    SecurityFilter->>OAuth2UserService: 6.3. loadUser(OAuth2UserRequest)
    activate OAuth2UserService
    OAuth2UserService->>UserService: 6.3.1. processOAuth2User(OAuth2User)
    activate UserService
    UserService->>UserRepo: 6.3.1.1. findByEmailOrCreate(email)
    activate UserRepo
    UserRepo-->>UserService: 6.3.1.2. User Entity
    deactivate UserRepo
    UserService-->>OAuth2UserService: 6.3.2. OAuth2UserPrincipal
    deactivate UserService
    OAuth2UserService-->>SecurityFilter: 6.4. Authentication (OAuth2UserPrincipal)
    deactivate OAuth2UserService
    SecurityFilter->>OAuth2AuthSuccessHandler: 6.5. onAuthenticationSuccess()
    activate OAuth2AuthSuccessHandler
    OAuth2AuthSuccessHandler->>JwtProvider: 6.5.1. generateAccessToken(UserPrincipal)
    activate JwtProvider
    OAuth2AuthSuccessHandler->>JwtProvider: 6.5.2. generateRefreshToken(UserPrincipal)
    JwtProvider-->>OAuth2AuthSuccessHandler: 6.5.3. AccessToken, RefreshToken
    deactivate JwtProvider
    OAuth2AuthSuccessHandler->>RefreshTokenService: 6.5.4. saveRefreshToken(UserPrincipal, RefreshToken)
    activate RefreshTokenService
    RefreshTokenService->>Redis: 6.5.4.1. SET [Username]:RefreshToken
    activate Redis
    Redis-->>RefreshTokenService: 6.5.4.2. OK
    deactivate Redis
    RefreshTokenService-->>OAuth2AuthSuccessHandler: 6.5.5. OK
    deactivate RefreshTokenService
    OAuth2AuthSuccessHandler->>AuditLogger: 6.5.6. Log: OAuth2 Login Success
    OAuth2AuthSuccessHandler-->>Client: 6.6. Redirect with Tokens (AccessToken in URL Fragment, RefreshToken in HttpOnly Cookie)
    deactivate OAuth2AuthSuccessHandler
    deactivate SecurityFilter

    Client-->>User: 7. OAuth2 Login Result (Redirected to Dashboard)
```


### 3. UC-AUTH-003: Access/Refresh Token 재발급 (Access/Refresh Token Reissue)

```mermaid
sequenceDiagram
    title UC-AUTH-003: Access/Refresh Token Reissue
    actor User
    participant Client as Client (Web/Mobile)
    participant AuthController as AuthController (Presentation Layer)
    participant AuthService as AuthService (Application Layer)
    participant JwtProvider as JwtProvider (Infrastructure Layer)
    participant RefreshTokenService as RefreshTokenService (Infrastructure Layer)
    participant Redis
    participant AuditLogger

    User->>Client: 1. AccessToken Expires
    Client->>AuthController: 2. POST /api/auth/refresh (RefreshToken from HttpOnly Cookie)
    activate AuthController
    AuthController->>AuthService: 3. refresh(RefreshToken)
    activate AuthService
    AuthService->>JwtProvider: 3.1. validateRefreshToken(RefreshToken)
    activate JwtProvider
    JwtProvider-->>AuthService: 3.2. Validation Result (true/false)
    deactivate JwtProvider

    alt RefreshToken Valid
        AuthService->>RefreshTokenService: 3.3. getRefreshToken(Username/Subject from token)
        activate RefreshTokenService
        RefreshTokenService->>Redis: 3.3.1. GET [Username]
        activate Redis
        Redis-->>RefreshTokenService: 3.3.2. StoredRefreshToken (or null)
        deactivate Redis
        RefreshTokenService-->>AuthService: 3.4. StoredRefreshToken

        alt StoredRefreshToken Matches ProvidedRefreshToken
            AuthService->>RefreshTokenService: 3.5. deleteRefreshToken(Username/Subject)
            RefreshTokenService->>Redis: 3.5.1. DEL [Username]
            activate Redis
            Redis-->>RefreshTokenService: 3.5.2. OK
            deactivate Redis
            AuthService->>RefreshTokenService: 3.6. blacklistToken(OldRefreshToken)
            RefreshTokenService->>Redis: 3.6.1. SET blacklist:[OldRefreshToken]
            activate Redis
            Redis-->>RefreshTokenService: 3.6.2. OK
            deactivate Redis
            RefreshTokenService-->>AuthService: 3.7. OK

            AuthService->>JwtProvider: 3.8. generateAccessToken(Username/Subject)
            activate JwtProvider
            AuthService->>JwtProvider: 3.9. generateRefreshToken(Username/Subject)
            JwtProvider-->>AuthService: 3.10. NewAccessToken, NewRefreshToken
            deactivate JwtProvider
            AuthService->>RefreshTokenService: 3.11. saveRefreshToken(Username/Subject, NewRefreshToken)
            RefreshTokenService->>Redis: 3.11.1. SET [Username]:NewRefreshToken
            activate Redis
            Redis-->>RefreshTokenService: 3.11.2. OK
            deactivate Redis
            RefreshTokenService-->>AuthService: 3.12. OK
            AuthService->>AuditLogger: 3.13. Log: Token Refresh Success
            AuthService-->>AuthController: 4. NewAccessToken, NewRefreshToken
            AuthController-->>Client: 5. HTTP 200 OK (NewAccessToken in Body, NewRefreshToken in HttpOnly Cookie)
        else StoredRefreshToken Does Not Match (Possible Theft)
            AuthService->>RefreshTokenService: 3.5'. deleteRefreshToken(Username/Subject)
            RefreshTokenService->>Redis: 3.5.1'. DEL [Username]
            activate Redis
            Redis-->>RefreshTokenService: 3.5.2'. OK
            deactivate Redis
            AuthService->>RefreshTokenService: 3.6'. blacklistToken(All tokens for User, or specific stolen token if identifiable)
            RefreshTokenService->>Redis: 3.6.1'. SET blacklist:[All User Tokens]
            activate Redis
            Redis-->>RefreshTokenService: 3.6.2'. OK
            deactivate Redis
            RefreshTokenService-->>AuthService: 3.7'. OK
            AuthService->>AuditLogger: 3.8'. Log: Refresh Token Theft Suspected
            AuthService-->>AuthController: 4'. SecurityException
            AuthController-->>Client: 5'. HTTP 403 Forbidden
        end
        deactivate RefreshTokenService
    else RefreshToken Invalid or Blacklisted
        AuthService->>AuditLogger: 3.3'. Log: Invalid/Blacklisted Refresh Token
        AuthService-->>AuthController: 4'. UnauthorizedException
        AuthController-->>Client: 5'. HTTP 401 Unauthorized
    end
    deactivate AuthService
    deactivate AuthController

    Client-->>User: 6. Token Reissue Result
```

### 4. UC-AUTH-004: 로그아웃 (Logout)

```mermaid
sequenceDiagram
    title UC-AUTH-004: Logout
    actor User
    participant Client as Client (Web/Mobile)
    participant AuthController as AuthController (Presentation Layer)
    participant AuthService as AuthService (Application Layer)
    participant RefreshTokenService as RefreshTokenService (Infrastructure Layer)
    participant JwtProvider as JwtProvider (Infrastructure Layer)
    participant Redis
    participant AuditLogger

    User->>Client: 1. Click Logout
    Client->>AuthController: 2. POST /api/auth/logout (AccessToken in Header, RefreshToken in HttpOnly Cookie)
    activate AuthController
    AuthController->>AuthService: 3. logout(AccessToken, RefreshToken)
    activate AuthService
    AuthService->>RefreshTokenService: 3.1. deleteRefreshToken(Username/Subject from RefreshToken)
    activate RefreshTokenService
    RefreshTokenService->>Redis: 3.1.1. DEL [Username]
    activate Redis
    Redis-->>RefreshTokenService: 3.1.2. OK
    deactivate Redis
    RefreshTokenService-->>AuthService: 3.2. OK

    AuthService->>RefreshTokenService: 3.3. blacklistToken(AccessToken)
    RefreshTokenService->>Redis: 3.3.1. SET blacklist:[AccessToken]
    activate Redis
    Redis-->>RefreshTokenService: 3.3.2. OK
    deactivate Redis
    AuthService->>RefreshTokenService: 3.4. blacklistToken(RefreshToken)
    RefreshTokenService->>Redis: 3.4.1. SET blacklist:[RefreshToken]
    activate Redis
    Redis-->>RefreshTokenService: 3.4.2. OK
    deactivate Redis
    RefreshTokenService-->>AuthService: 3.5. OK
    deactivate RefreshTokenService
    AuthService->>AuditLogger: 3.6. Log: User Logout Success
    AuthService-->>AuthController: 4. Logout Success
    deactivate AuthService
    AuthController-->>Client: 5. HTTP 200 OK (Clear RefreshToken Cookie)
    deactivate AuthController
    Client-->>User: 6. Logout Result
```

